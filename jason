#!/usr/bin/env bash
shopt -u xpg_echo
json=$(cat)

declare -a seen
declare obj
declare level
key=( this )

function keypath() {
  echo -n ${key[0]} && [ ${#key[*]} -gt 1 ] && printf "[%s]" "${key[@]:1}"
}

index=0
depth=0
char=1
until [[ -z "$char" ]]; do
  char=${json:$index:1}
  let index=index+1

  case "${char}" in ( '' )
    ;; ( ':' | ',' )
      [[ ${level:0:1} == '[' ]] && key[$depth]=$[ ${key[$depth]} + 1 ]
      obj="${obj}${char} "
    ;; ( [tfn] )
      [[ $char == 'f' ]] && length=4 || length=3
      value="${char}${json:$index:$length}"
      [[ $value =~ true|null|false ]] || exit 1
      let index=index+$length
    ;; ( '{' | '[' )
      let depth=depth+1
      level="${char}${level}"
      seen[$depth-1]="$obj"
      seen[$depth]="${char} "
      obj="${seen[$depth]}"
      key[$depth]=0
    ;; ( '}' | ']' )
      unset key[$depth]
      let depth=depth-1
      [[ ${#obj} == 2 ]] && value="${level:0:1} ${char}" || value="${obj} ${char}"
      level="${level:1}"
      obj="${seen[$depth]}"
    ;; ( '"' )
      value="$(expr "${json:$index-1}" : '\("\(\(\([^\"]*\([\][^"]\)*\)*[\]"\)*\)*\([^"]\)*"\)')"
      let index=index+${#value}-1
      if [[ ${level:0:1} == '{' && ${obj: -2} != ': ' ]]; then
        key[$depth]="$value"
        obj="${obj}${value}"
        unset value
      fi
    ;; ( [-0-9] )
      value="$(expr "${json:$index-1}" : '\(-\{0,1\}\([0-9]*\.\)\{0,1\}[0-9]*[eE]\{0,1\}[+-]\{0,1\}[0-9]*\)')"
      let index=index+${#value}-1
    ;; ( [[:space:]] )
    ;; ( * ) exit 1
  esac

  if [[ ! -z $value ]]; then
    echo "$(keypath): $value"
    obj="${obj}${value}"
    unset value
  fi
done
